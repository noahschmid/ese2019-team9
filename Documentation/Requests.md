# Requests

- [Requests](#requests)
  - [User Requests](#user-requests)
  - [Review Requests](#review-requests)
  - [Product Requests](#product-requests)
  - [Payment Requests](#payment-requests)
  - [Order Requests](#order-requests)
  - [Notification Requests](#notification-requests)
  - [Categories Requests](#categories-requests)

## User Requests

Base Api: '/user'. [Controller file](../ESE-2019-Project/backend/api/controllers/user.js)

 |  Type  |   Path  | Header |       Body       | Return | Description |
|:------:|:--------:|:------:|:----------------:|--------|------------|
 | patch  | /verify | `none` | {token: `token`} | Returns <ul><li>*200 OK* `{message: 'Email successfully verified'}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Tries to verify a users email with the token being the given token via email
| post  | /signup | `none` | {email: `userEmail`, password: `userPassword`} | Returns <ul><li>*201 Ok* `{message: 'User created and verification email sent', createdUser}`</li><li>*409 Conflict* `{message: 'User with same email already exists', createdUser}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Creates a new user and sends verification email
| post  | /login | `none` | {email: `userEmail`, password: `userPassword`} | Returns <ul><li>*200 OK* `{ message: 'Authentication successful', token, id: user._id}`</li><li>*401 Unauthorized* `{message: 'Authentication failed'}`</li><li>*406 Not Acceptable* `{ message: 'Authentication failed'}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Log the user in and return the user if the credentials were correct
| post  | /resend | `none` | {email: `userEmail`, id: `userId`} | Returns <ul><li>*200 OK* `{message: 'Verification successfully resent'}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Resends the email verification link
| post  | /forgot | `none` | {email: `userEmail`} | Returns <ul><li>*200 OK* `{message:'reset link sent'}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Sends a link with a token to reset the password if the email exists, else sends email notification that someone tried to reset the password on the email that isn't registered with a link to the homepage
| patch  | /reset | `none` | {token: `token`, password: `password`} | Returns <ul><li>*200 OK* `{message: 'password-reset successful'}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Updates the password of a user if the token is valid and the user is found
| get  | /`<userId>` | {token: `token`} | {} | Returns <ul><li>*200 OK* `{_id: userId, admin*: userAdminFlag, email*: userEmail, verifiedEmail*: userVerifiedEmailFlag, name: userName, address: userAddress, country: userCountry, website: userWebsite, phone: userPhonenumber, sex: userSex, image: imagePath, productsSold: numberofProductsSold}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Returns the detail information of the user that was requested via the users id.  *\*These fields are only returned if the user has made the request for the own userdata or is an admin*
| get  | / | {token: `token`} | {} | Returns <ul><li>*200 OK* `{_id: userId, admin: userAdminFlag, email: userEmail, verifiedEmail: userVerifiedEmailFlag, name: userName, address: userAddress, country: userCountry, website: userWebsite, phone: userPhonenumber, sex: userSex, image: imagePath, productsSold: numberofProductsSold}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns the detail information of all users. The requesting user has to be an admin
| patch  | /`<userId>` | {token: `token`} | {userId: `userId`, field1: `field1Value`... } | Returns <ul><li>*200 OK* `{message: 'successfully updated'}`</li><li>*501 Not Implemented* `{error: errorMessage}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Patches the given fields of the user. `Admin` only accepts `true` or `false`, `Sex` only accepts `'male'` or `'female`
| delete  | /`<userId>` | {token: `token`} | {} | Returns <ul><li>*200 OK* `{message: 'User deleted'}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Deletes the user if the requesting user is the user itself or an admin

## Review Requests

Base Api: '/review'. [Controller file](../ESE-2019-Project/backend/api/controllers/review.js)

|  Type  |   Path  | Header |       Body       | Return | Description |
|:------:|:--------:|:------:|:----------------:|--------|------------|
| post  | /add | {token: `token`} | {rating: `<number from 1 to 5>`, productId: `productId`, comment?\*: `comment`} | Returns <ul><li>*200 OK* `{review, message: 'Review added'}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Creates a new review to the given Product from the user that is transferred via the token. *\*comment field is optional*
| patch  | /`<reviewId>` | {token: `token`} | {rating?\*: `<number from 1 to 5>`, productId?\*: `productId`, comment?\*: `comment`} | Returns <ul><li>*200 OK* `{message: "Review updated", updatedReview: result}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Patches the given fields of the Review. Only an admin and the owner of the review can edit it. *\*You must only submit the fields to change*
| delete  | /`<reviewId>` | {token: `token`} | {} | Returns <ul><li>*200 OK* `{message: 'successfully deleted'}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Deletes the review if the requesting user is the owner of the review or an admin
| get  | / | {token: `token`} | {} | Returns <ul><li>*200 OK* `[ {"_id": <reviewId>,"rating": <rating>,"comment?": <comment>,"user": <owner of the review>,"product":<productId>},{"_id": <reviewId>,"rating": <rating>,"comment?": <comment>,"user": <owner of the review>,"product":<productId>}, ... ]`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns the detail information of all reviews. *\*As the comment field on reviews is optional, only returns that field when it is defined*. The requesting user has to be an admin.

## Product Requests

Base Api: '/product'. [Controller file](../ESE-2019-Project/backend/api/controllers/product.js)

|  Type  |   Path  | Header |       Body       | Return | Description |
|:------:|:--------:|:------:|:----------------:|--------|------------|
| get  | / | {token: `token`} | {} | Returns <ul><li>*200 OK* `[{ "_id": <productId>, "name": <productName>, "category": {"_id": <categoryId>, "name": <categoryName>, "id": <categoryId> }, "price": <productPrice>, "verified": <true | false>, "seller": {"_id": <userId>, "email": <userEmail>, "address": <userAddress>, "country": <userCountry>, "name": <userName>, "phone": <userPhonenumber>, "sex": <'male' | 'female'> }, "description": <description>, "location": <productLocation>, "rating": <number between 0 and 5>, "image": <imageSrc>, "toRevise": <true | false>, "date": <dateString>}, ... ]`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns all products if the requesting user is an admin or just the verified products for everyone else. In the seller information every information of the seller is returned, except the passwordHash, the admin flag and the verified Email flag
| get  | /`<productId>` | {token: `token`} | {} | Returns <ul><li>*200 OK* ``[{ "_id": <productId>, "name": <productName>, "category": {"_id": <categoryId>, "name": <categoryName>, "id": <categoryId> }, "price": <productPrice>, "verified": <true | false>, "seller": {"_id": <userId>, "email": <userEmail>, "address": <userAddress>, "country": <userCountry>, "name": <userName>, "phone": <userPhonenumber>, "sex": <'male' | 'female'> }, "description": <description>, "location": <productLocation>, "rating": <number between 0 and 5>, "reviews": [{"_id": <reviewId>, "rating": <1 | 2 | 3 | 4 |5>, "comment"?*: <reviewComment>, "user": { "_id": <userId>, "name": <userName>}, "product": <productId>}, ...], "image": <imageSrc>, "toRevise": <true | false>, "date": <dateString>}, ... ]`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns the detail information a single product including its reviews. The requesting user has to be the seller of the product or an admin.*\*As the comment field on reviews is optional, only returns that field in the review object when it is defined*. 
| post  | /add | {token: `token`} | {name: `<productName>`, price: `<productPrice>`, location: `<productLocation>`, description: `<productDescription>` , categorySlug: `<slug of the category>`} | Returns <ul><li>*200 OK* `{message: "Product created", createdProduct: { name: <productName>, _id: <productId>, category: <categoryName>, price: <productPrice>, description: <productDescription>, location: <productLocation>, seller: <sellerId>, image: <productImagePath>, date: <createdAtDateString> }`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Creates a new product with the given Information, if the user is a seller (has set a name, address and country in his profile).
| patch  | /`<productId>` | {token: `token`} | {`<fieldNameToUpgrade>:<newValue>`, ...} | Returns <ul><li>*200 OK* `{message: "Product updated"}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Patches the given fields of the Products. This can only be done by admins or the seller. Sets the verified Field to `false`. The admin can prevent this by sending the field `'verified':true`. Only an admin and the owner of the product can edit it. If the product gets verified (`'verified': true`) or is being marked as having to be revised (`'toRevise': true`) the seller gets a notification `const notification = new Notification({_id: notificationId,  user: <sellerOfTheProduct>, text: <"Your product <productName> as been verified." | "Please revise your product <productName>">", date: <today>, link: "/selling" });` *\*You must only submit the fields to change*
| delete  | /`<productId>` | {token: `token`} | {} | Returns <ul><li>*200 OK* `{message: 'Product deleted'}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Deletes the product an its corresponding orders if the requesting user is the owner of the product or an admin
| get  | /user/`<userId>` | `none` | {} | Returns <ul><li>*200 OK* `[{ "_id": <productId>, "name": <productName>, "category": {"_id": <categoryId>, "name": <categoryName>, "id": <categoryId> }, "price": <productPrice>, "verified": <true | false>, "seller": {"_id": <userId>, "email": <userEmail>, "address": <userAddress>, "country": <userCountry>, "name": <userName>, "phone": <userPhonenumber>, "sex": <'male' | 'female'> }, "description": <description>, "location": <productLocation>, "rating": <number between 0 and 5>, "image": <imageSrc>, "toRevise": <true | false>, "date": <dateString>}, ... ]`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns all products of the requested user. In the seller information every information of the seller is returned, except the passwordHash, the admin flag and the verified Email flag
| get  | /hasBought/`<productId>` | {token: `token`} | {} | Returns <ul><li>*200 OK* {`hasBought: <true | false>`}</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul>  | Returns wheter a user has already bought and paid the product

## Payment Requests

Base Api: '/payment'. [Controller file](../ESE-2019-Project/backend/api/controllers/payment.js)

|  Type  |   Path  | Header |       Body       | Return | Description |
|:------:|:--------:|:------:|:----------------:|--------|------------|
| post  | /create | {token: `token`} | {orderId: `<orderId>`} | Returns <ul><li>*200 OK* `{token: token, payment: payment}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Creates a new product with the given Information, if the user is a seller (has set a name, address and country in his profile).
| post  | /execute | {token: `token`} | {payerId: `<userId>`, token: `<paymentToken>`, paymentId: `<paymentId>`} | Returns <ul><li>*200 OK* `{message: 'Payment successful', orderId: <orderId>, loginToken: <loginToken>}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Executes the payment and if successful adds a new notification for the seller and a new chat status message to the order. The buyer can from now on create a new review for the product

## Order Requests

Base Api: '/order'. [Controller file](../ESE-2019-Project/backend/api/controllers/order.js)

|  Type  |   Path  | Header |       Body       | Return | Description |
|:------:|:--------:|:------:|:----------------:|--------|------------|
| get | /id/`<orderId>`| {token: `token`} | {} | Returns <ul><li>*200 OK* `{ _id: <orderId>, startDate: <startDate>, endDate: <endDate>, status: <status>, orderDate: <orderDate>, reviewed: <true | false>, seller: { _id: <sellerId>, name: <sellerName>, email: <sellerEmail>, address: <sellerAddress>, country: <sellerCountry>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><sellerImagePath>'> }, buyer: { _id: <buyerId>, name: <buyerName>, email: <buyerEmail>, address: <buyerAddress>, country: <buyerCountry>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><buyerImagePath>'> }, product: { _id: <productId>, name: <productName>, price: <productPrice>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><productImagePath>'>}, chat: [{ _id: <messageId>, sender: { _id: <senderId>, name: <buyerName | sellerName>, email: <buyerEmail | sellerEmail>, image: <buyerName | sellerName |<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png>} , date: <messageDate>, statusMessage: <statusMessage>, message: <messageText> }] }`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Gets all information of a specific order by the orderId
| get | /seller | {token: `token`} | {} | Returns <ul><li>*200 OK* `{ _id: <orderId>, startDate: <startDate>, endDate: <endDate>, status: <status>, orderDate: <orderDate>, buyer: { _id: <buyerId>, name: <buyerName>, email: <buyerEmail>, address: <buyerAddress>, country: <buyerCountry>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><buyerImagePath>'> }, product: { _id: <productId>, name: <productName>, price: <productPrice>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><productImagePath>'>}, chat: <chat> }`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns all orders (excpet rejected) for a specific seller.
| get | /seller/new | {token: `token`} | {} | Returns <ul><li>*200 OK* `{ _id: <orderId>, startDate: <startDate>, endDate: <endDate>, status: <status>, orderDate: <orderDate>, buyer: { _id: <buyerId>, name: <buyerName>, email: <buyerEmail>, address: <buyerAddress>, country: <buyerCountry>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><buyerImagePath>'> }, product: { _id: <productId>, name: <productName>, price: <productPrice>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><productImagePath>'>}, chat: <chat> }`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns all order in pending status for a specific seller
| get | /buyer | {token: `token`} | Returns <ul><li>*200 OK* `{ _id: <orderId>, startDate: <startDate>, endDate: <endDate>, status: <status>, orderDate: <orderDate>, seller: { _id: <sellerId>, name: <sellerName>, email: <sellerEmail>, address: <sellerAddress>, country: <sellerCountry>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><sellerImagePath>'> }, product: { _id: <productId>, name: <productName>, price: <productPrice>, image: <'<process.env.PUBLIC_DOMAIN_API>/rsc/no-user-image.png' | '<process.env.FILE_STORAGE><productImagePath>'>}, chat: <chat> }`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Returns all orders of a buyer
| post | /place | {token: `token`} | {productId: `<productId>`, startDate: `<startDate>`, endDate: `<endDate>`} | Returns <ul><li>*200 OK* `{message: "Order successfully placed", order: createdOrder}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Places a new order on the given Product. Notifies the seller about a new order
| patch | /accept | {token: `token`} | {orderId: `<orderId>`} | Returns <ul><li>*200 OK* `{message: "Order accepted"}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Accepts an order that isn't in paid state and notifies the seller about it. Can be done by the seller or an Admin
| patch | /reject | {token: `token`} | {orderId: `<orderId>`} | Returns <ul><li>*200 OK* `{message: "Order rejected"}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Rejects an order that isn't in paid state and notifies the seller about it. Can be done by the seller or an Admin
| patch | /pay | {token: `token`} |  {orderId: `<orderId>`} | Returns <ul><li>*200 OK* `{message: "Order paid"}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Pay an order that is in accepted state and notifies the seller about it. Can be done by the seller or an Admin
| post | /message/send | {token: `token`} | {orderId: `<orderId>`, message: `<message>`} | Returns <ul><li>*200 OK* `{message:"Message sent"}`</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Adds a new message to the chat. Can only be done by the buyer and the seller of the product. 

## Notification Requests

Base Api: '/notification'. [Controller file](../ESE-2019-Project/backend/api/controllers/notifications.js)

|  Type  |   Path  | Header |       Body       | Return | Description |
|:------:|:--------:|:------:|:----------------:|--------|------------|
| get | / | {token: `token`} | {} | Returns <ul><li>*200 OK* `[{ "read": <true | false>, "forall": <true | false>, "_id": <notificationId>, "user": <userId>, "text": <messageText>, "date": <dateString>, "link": "<relLink> }, ... ]`</li><li>*500 Internal Server Error* `error.message as JSON`</li></ul> | Get all notifications of all users. The requesting user has to be an admin.
| get | /user | {token: `token`} | {} |Returns <ul><li>*200 OK* `{unread: <numberOfUnreadNotifications>, notifications: [{ "read": <true | false>, "forall": <true | false>, "_id": <notificationId>, "user": <userId>, "text": <messageText>, "date": <dateString>, "link": "<relLink> }, ... ] }`</li><li>*500 Internal Server Error* `{message: 'no notification found'}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Get all notifications of the logged in user. 
| post | /`<userId>` | {token: `token`} | {message: `<message>`, link: `<relativeLink>`, uId: `<receiverId>`} | Returns <ul><li>*201 Created* `{message: 'Notification sent', notification: savedNotification}`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Sends a new notification to a user specified by the uId.
| delete | /user | {token: `token`} | {} | Returns <ul><li>*200 OK* `{message: 'all notifications deleted'}`</li><li>*501 Not Implemented* `{message: errorMessage}`</li></ul> | Deletes all notifications of a user
| patch | /user | {token: `token`} | {} | Returns <ul><li>*200 OK* `message: 'read flag set'`</li><li>*500 Internal Server Error* `{message: errorMessage}`</li></ul> | Sets all notifications of the user to `read: true`
| delete | /`<notificationsId>` | {token: `token`} | Returns <ul><li>*200 OK* `{message: 'all notifications deleted'}`</li><li>*500 Internal Server Error* `error as JSON`</li></ul> | Deletes a specific Notification

## Categories Requests

Base Api: '/category'. [Controller file](../ESE-2019-Project/backend/api/controllers/category.js)

|  Type  |   Path  | Header |       Body       | Return | Description |
|:------:|:--------:|:------:|:----------------:|--------|------------|
| get | / | `none` | {} | Returns <ul><li>*200 OK* `[{"_id": <categoryId>, "name": <categoryName>, "image": <categoryImagePath>, "subcategories": [ { "_id": <csubategoryId>, "name": <subcategoryName>, "slug": subcategorySlug>, "image": <subcategoryImagePath> }, ... ], "slug": <categoryId>}, ...] `,</li><li>*500 Internal Server Error* `error.message as JSON`</li></ul> | Returns basic information about all categories with every subcategory.
| get | /`<categorySlug>` |  {token: `token`} | {} | Returns <ul><li>*200 OK* `[{_id:<categoryId>, name:<categoryName>, parent:<parentCategory>, image:<categoryImagePath>, subcategories: <categorySubcategories>, products*: [{"name": <productName>, "_id": <productId>, "description": <productDescription>, "image": <productImagePath>, "rating": <number between 0 and 5>, "seller": { "_id": <sellerId>, "name": <sellerName>, "image"**: <sellerImage> } }, ... ] }] `,</li><li>*500 Internal Server Error* `error.message as JSON`</li></ul> | Returns detailed information about a single (Sub)category. *\*To non-admins only returns verified products. \*\*Only returns an image if the seller has set a profile picture* 
| post | /add | {token: `token`} | {slug: `<categorySlug>`, name: `<categoryName>`, image: `<categoryImage>`, parentSlug?\*: `<parentCategorySlug>`} | Returns <ul><li>*201 Created* `message:'New category created', createdCategory:{ name: <categoryName>, slug: <categorySlug>, _id: <categoryId>, parent: <parentCategorySlug>, image: <parentCategoryImagePath> }`,</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Creates a new (Sub)category. The requesting user has to be an admin. *\*If the parentSlug is defined it creates a new subcategory on this Category, if it is not defined the newly created Category is a category instead of a subcategory*
| delete | /`<categoryId>` | {token: `token`} | {} | Returns <ul><li>*200 OK* `{message: "Category deleted"}`,</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Deletes a category and its subcategories. The requesting user has to be an admin.
| patch | /`<categoryId>` | {token: `token`} | {slug?\*: `<categorySlug>`, name?\*: `<categoryName>`,  parent?\*: `<parentCategorySlug>`, image?\*: `<categoryImage>`} | Returns <ul><li>*200 OK* `{message:'Category updated'}`,</li><li>*500 Internal Server Error* `{error: errorMessage}`</li></ul> | Updates the category specified by the categoryId. You only have to specify the fields you want to update. The requesting user has to be an admin.*\* All fields are optional. Just include the fields you want to be updated*